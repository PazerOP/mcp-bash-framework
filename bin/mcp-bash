#!/usr/bin/env bash
# Spec §1 bullet 1: mcp-bash must execute on Bash ≥3.2 across macOS/Linux/WSL without edits.
# Spec §1 bullet 3: core targets MCP protocol version 2025-06-18 and maintains stdout discipline.
# Spec §1 bullet 6: transport scope is limited to stdio; no alternative transports are supported.

set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  mcp-bash                 # launch server
  mcp-bash scaffold tool <name>
EOF
}

mcp_scaffold_tool() {
  local name="$1"
  if [ -z "${name}" ]; then
    printf 'Tool name required\n' >&2
    exit 1
  fi
  initialize_runtime_paths
  local scaffold_dir="${MCPBASH_ROOT}/scaffold/tool"
  if [ ! -d "${scaffold_dir}" ]; then
    printf 'Scaffold templates missing at %s\n' "${scaffold_dir}" >&2
    exit 1
  fi
  local target_dir="tools/${name}"
  if [ -e "${target_dir}" ]; then
    printf 'Target %s already exists\n' "${target_dir}" >&2
    exit 1
  fi
  mkdir -p "${target_dir}"
  sed "s/__NAME__/${name}/g" "${scaffold_dir}/tool.sh" >"${target_dir}/${name}.sh"
  chmod +x "${target_dir}/${name}.sh"
  sed "s/__NAME__/${name}/g" "${scaffold_dir}/tool.meta.yaml" >"${target_dir}/${name}.meta.yaml"
  sed "s/__NAME__/${name}/g" "${scaffold_dir}/README.md" >"${target_dir}/README.md"
  printf 'Scaffolded tool at %s\n' "${target_dir}"
  exit 0
}

# Spec §1 bullet 2: keep a stable, versioned core separated from extension directories.
MCPBASH_SERVER_NAME="mcp-bash"
MCPBASH_SERVER_TITLE="MCP Bash Server"
MCPBASH_SERVER_VERSION="0.1.0"
MCPBASH_PROTOCOL_VERSION="2025-06-18"
MCPBASH_NEGOTIATED_PROTOCOL_VERSION="${MCPBASH_PROTOCOL_VERSION}"
MCPBASH_ROOT=""

require_bash_runtime() {
  if [ -z "${BASH_VERSION-}" ]; then
    printf 'mcp-bash must be launched with Bash; current shell is incompatible.\n' >&2
    exit 1
  fi

  local major="${BASH_VERSINFO[0]}"
  local minor="${BASH_VERSINFO[1]}"

  if [ "${major}" -lt 3 ] || { [ "${major}" -eq 3 ] && [ "${minor}" -lt 2 ]; }; then
    printf 'mcp-bash requires Bash 3.2 or newer (detected %s).\n' "${BASH_VERSION}" >&2
    exit 1
  fi
}

# Spec §1 bullet 2 and Spec §2 filesystem expectations: establish project root and source runtime detection helpers.
initialize_runtime_paths() {
  local script_dir=""

  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  MCPBASH_ROOT="$(cd "${script_dir}/.." && pwd)"

  local required_libs="runtime json ids lock io paginate logging spec tools resources prompts completion rpc core"
  local lib

  for lib in ${required_libs}; do
    if [ ! -r "${MCPBASH_ROOT}/lib/${lib}.sh" ]; then
      printf '%s\n' "Missing required library at ${MCPBASH_ROOT}/lib/${lib}.sh (Spec §4 bootstrap prerequisites)." >&2
      exit 1
    fi
  done

  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/runtime.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/json.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/ids.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/lock.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/io.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/paginate.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/logging.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/spec.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/tools.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/resources.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/prompts.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/completion.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/rpc.sh"
  # shellcheck disable=SC1090
  . "${MCPBASH_ROOT}/lib/core.sh"
}

mcp_verify_stdout_target() {
  # Spec §4: reject configurations where stdout is not connected to a pipe or terminal.
  if [ -t 1 ]; then
    return 0
  fi

  # macOS/Linux expose /dev/stdout as a character device even when piped; fall back to a write probe.
  if ! { : >&1; } 2>/dev/null; then
    printf '%s\n' 'mcp-bash requires stdout to be connected to an active pipe or terminal (Spec §4).' >&2
    exit 1
  fi
}

main() {
  require_bash_runtime
  initialize_runtime_paths
  mcp_verify_stdout_target
  mcp_runtime_detect_json_tool
  mcp_runtime_log_batch_mode

  trap 'mcp_runtime_cleanup' EXIT INT TERM

  if mcp_runtime_is_minimal_mode; then
    # Spec §2 minimal mode table: warn about reduced capability surface.
    printf '%s\n' 'Operating in minimal mode: only lifecycle, ping, and logging handlers are exposed until JSON tooling becomes available (Spec §2).' >&2
  fi

  # Spec §4 bootstrap: begin primary lifecycle loop.
  mcp_core_run
}

if [ "${1-}" = "scaffold" ]; then
  shift
  case "${1-}" in
    tool)
      shift
      mcp_scaffold_tool "${1:-}"
      ;;
    *)
      usage
      exit 1
      ;;
  esac
fi

main "$@"
